name: Execute ZKVM-Perf

on:
  workflow_dispatch:
    inputs:
      instance_types:
        description: 'Instance types'
        required: true
        type: boolean
        options:
        - g6.16xlarge
        - g6.8xlarge
        - g6.4xlarge
        - g6.2xlarge
      ami_id:
        description: 'AMI ID'
        required: true
        type: string
        default: 'ami-079a6a210557ef0e4'
      provers:
        description: 'Provers to use'
        required: true
        type: choice
        options:
        - sp1
        - risc0
      programs:
        description: 'Programs to benchmark'
        required: true
        type: choice
        options:
        - loop
        - fibonacci
        - tendermint
        - reth1
        - reth2
      filename:
        description: 'Filename for the benchmark'
        required: true
        default: 'benchmark'
        type: string
      trials:
        description: 'Number of trials to run'
        required: true
        default: '1'
        type: number
      hashfns:
        description: 'Hash functions to use'
        required: true
        type: choice
        options:
        - poseidon
      shard_sizes:
        description: 'Shard sizes to use'
        required: true
        default: '22'
        type: string
      block_1:
        description: 'Block number for reth1'
        required: true
        default: '17106222'
        type: string
      block_2:
        description: 'Block number for reth2'
        required: true
        default: '19409768'
        type: string
      
  pull_request:
    branches: [main]

jobs:
  matrix-setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          INSTANCES=$(echo '${{ toJson(inputs.instance_types) }}' | jq -c 'to_entries | map(select(.value == true)) | map(.key)')
          echo "matrix=${INSTANCES}" >> $GITHUB_OUTPUT

  perf:
    needs: matrix-setup
    strategy:
      matrix:
        instance_type: ${{fromJson(needs.matrix-setup.outputs.matrix)}}
    name: Run ZKVM-Perf on ${{ matrix.instance_type }}
    runs-on: ubuntu-latest
    steps:
      - name: Start EC2 runner
        id: start-ec2-runner
        uses: machulav/ec2-github-runner@v2
        with:
          mode: start
          github-token: ${{ secrets.GH_PAT }}
          ec2-image-id: ${{ inputs.ami_id }}
          ec2-instance-type: ${{ matrix.instance_type }}
          subnet-id: ${{ secrets.AWS_SUBNET_ID }}
          security-group-id: ${{ secrets.AWS_SG_ID }}

      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Run ZKVM-Perf
        env:
          INSTANCE_TYPE: ${{ matrix.instance_type }}
        run: |
          # Your ZKVM-Perf commands here
          echo "Running on $INSTANCE_TYPE"
          # Add your docker commands and other steps here

      - name: Stop EC2 runner
        if: always()
        uses: machulav/ec2-github-runner@v2
        with:
          mode: stop
          github-token: ${{ secrets.GH_PAT }}
          label: ${{ steps.start-ec2-runner.outputs.label }}
          ec2-instance-id: ${{ steps.start-ec2-runner.outputs.ec2-instance-id }}